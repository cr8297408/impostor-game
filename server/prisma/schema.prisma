// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AUTENTICACIÓN Y USUARIOS
// ============================================

model User {
  id            String        @id @default(uuid())
  email         String?       @unique
  username      String        @unique
  avatarColor   String        @default("#3b82f6")

  // Supabase Auth ID (si está autenticado)
  supabaseId    String?       @unique

  // Si es anónimo
  isAnonymous   Boolean       @default(true)

  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  lastLoginAt   DateTime      @default(now())

  // Relaciones
  stats         UserStats?
  gamePlayers   GamePlayer[]
  clues         Clue[]
  votes         Vote[]

  @@index([supabaseId])
  @@index([username])
  @@map("users")
}

model UserStats {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Estadísticas generales
  gamesPlayed           Int      @default(0)
  gamesWon              Int      @default(0)
  gamesLost             Int      @default(0)

  // Como impostor
  gamesAsImpostor       Int      @default(0)
  winsAsImpostor        Int      @default(0)
  lossesAsImpostor      Int      @default(0)

  // Como civil
  gamesAsCivilian       Int      @default(0)
  winsAsCivilian        Int      @default(0)
  lossesAsCivilian      Int      @default(0)

  // Rachas
  currentStreak         Int      @default(0)
  bestStreak            Int      @default(0)

  // Métricas adicionales
  totalCluesGiven       Int      @default(0)
  totalVotesCast        Int      @default(0)
  timesEliminated       Int      @default(0)
  correctImpostorGuesses Int     @default(0)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("user_stats")
}

// ============================================
// JUEGOS Y PARTIDAS
// ============================================

model Game {
  id                String        @id @default(uuid())
  roomId            String        @unique

  // Configuración
  category          String        @default("general")
  maxRounds         Int           @default(3)
  timePerClue       Int           @default(60)

  // Estado del juego
  status            GameStatus    @default(LOBBY)
  secretWord        String?
  currentRound      Int           @default(1)

  // Resultado
  winner            WinnerType?   // 'impostor' | 'civilians'
  eliminatedPlayerId String?

  // Timestamps
  createdAt         DateTime      @default(now())
  startedAt         DateTime?
  endedAt           DateTime?

  // Relaciones
  players           GamePlayer[]
  clues             Clue[]
  votes             Vote[]

  @@index([roomId])
  @@index([status])
  @@index([createdAt])
  @@map("games")
}

enum GameStatus {
  LOBBY
  PLAYING
  VOTING
  FINISHED
  ABANDONED
}

enum WinnerType {
  IMPOSTOR
  CIVILIANS
}

model GamePlayer {
  id              String    @id @default(uuid())
  gameId          String
  userId          String

  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Rol en el juego
  isImpostor      Boolean   @default(false)
  isEliminated    Boolean   @default(false)
  votesReceived   Int       @default(0)

  // Timestamps
  joinedAt        DateTime  @default(now())

  @@unique([gameId, userId])
  @@index([gameId])
  @@index([userId])
  @@map("game_players")
}

model Clue {
  id              String    @id @default(uuid())
  gameId          String
  userId          String

  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  text            String
  round           Int

  createdAt       DateTime  @default(now())

  @@index([gameId])
  @@index([userId])
  @@map("clues")
}

model Vote {
  id              String    @id @default(uuid())
  gameId          String
  voterId         String
  votedPlayerId   String

  game            Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)
  voter           User      @relation(fields: [voterId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())

  @@unique([gameId, voterId])
  @@index([gameId])
  @@map("votes")
}
